<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <meta name="generator" content="Hugo 0.73.0" />

  
  <meta name="description" content="Some description">
  

  
  <link rel="apple-touch-icon" sizes="180x180" href="https://example.com/apple-touch-icon.png">

  
  <link rel="icon" type="image/png" sizes="32x32" href="https://example.com/favicon-32x32.png">

  
  <link rel="icon" type="image/png" sizes="16x16" href="https://example.com/favicon-16x16.png">

  
  <link rel="manifest" href="https://example.com/site.webmanifest">

  
  <link rel="mask-icon" href="https://example.com/safari-pinned-tab.svg" color="#5bbad5">

  <meta name="msapplication-TileColor" content="#da532c">

  <meta name="theme-color" content="#ffffff">

  
  <link rel="stylesheet" href="https://example.com/css/bootstrap.min.css" />

  
  <title>Postgres full text search | Some Title</title>
  

  <style>
  body {
    min-width: 300px;
  }

  .custom-navbar {
    margin-bottom: 1em;
    height: 60px;
  }

  .custom-navbar a {
    display: inline-block;
    padding: 18px 0;
    margin-right: 1em;
    font-weight: bold;
  }

  .custom-navbar a:hover,
  .custom-navbar a:focus {
    text-decoration: none;
  }

  @media print {
    .custom-navbar {
      display: none;
    }
  }

  article {
    padding-bottom: 1em;
  }

  img {
    max-width: 100%;
  }

    {
      {
      with .Site.Params.contentBackgroundColor
    }
  }

  body {
    background-color: {
        {
        . | safeCSS
      }
    }

    ;
  }

    {
      {
      else
    }
  }

  body {
    background-color: #fff;
  }

    {
      {
      end
    }
  }

    {
      {
      with .Site.Params.contentTextColor
    }
  }

  body {
    color: {
        {
        . | safeCSS
      }
    }

    ;
  }

    {
      {
      else
    }
  }

  body {
    color: #212529;
  }

    {
      {
      end
    }
  }

    {
      {
      with .Site.Params.contentLinkColor
    }
  }

  a {
    color: {
        {
        . | safeCSS
      }
    }

    ;
  }

    {
      {
      else
    }
  }

  a {
    color: #007bff;
  }

    {
      {
      end
    }
  }

    {
      {
      with .Site.Params.contentLinkHoverColor
    }
  }

  a:hover,
  a:focus {
    color: {
        {
        . | safeCSS
      }
    }

    ;
  }

    {
      {
      else
    }
  }

  a:hover,
  a:focus {
    color: #0056b3;
  }

    {
      {
      end
    }
  }

    {
      {
      with .Site.Params.navbarBackgroundColor
    }
  }

  .custom-navbar {
    background-color: {
        {
        . | safeCSS
      }
    }

    ;
  }

    {
      {
      else
    }
  }

  .custom-navbar {
    background-color: #212529;
  }

    {
      {
      end
    }
  }

    {
      {
      with .Site.Params.navbarLinkColor
    }
  }

  .custom-navbar a {
    color: {
        {
        . | safeCSS
      }
    }

    ;
  }

    {
      {
      else
    }
  }

  .custom-navbar a {
    color: rgba(255, 255, 255, .75);
  }

    {
      {
      end
    }
  }

    {
      {
      with .Site.Params.navbarLinkHoverColor
    }
  }

  .custom-navbar a:hover,
  .custom-navbar a:focus {
    color: {
        {
        . | safeCSS
      }
    }

    ;
  }

    {
      {
      else
    }
  }

  .custom-navbar a:hover,
  .custom-navbar a:focus {
    color: rgba(255, 255, 255, 1);
  }

    {
      {
      end
    }
  }

    {
      {
      with .Site.Params.wrapperMaxWidth
    }
  }

  .container {
    max-width: {
        {
        . | safeCSS
      }
    }

    ;
  }

    {
      {
      else
    }
  }

  .container {
    max-width: 800px;
  }

    {
      {
      end
    }
  }

    {
      {
      if eq .Site.Params.customCodeStyle true
    }
  }

  pre {
    display: block;
    padding: 9.5px;
    word-break: break-all;
    word-wrap: break-word;
    background-color: #f5f5f5;
    border: 1px solid #ccc;
    border-radius: 4px;
  }

  pre code {
    padding: 0;
    font-size: inherit;
    color: inherit;
    white-space: pre-wrap;
    background-color: transparent;
    border: none;
    border-radius: 0;
  }

  code {
    padding: 2px 4px;
    color: inherit;
    background-color: #f5f5f5;
    border: 1px solid #ccc;
    border-radius: 4px;
    font-size: .9em;
  }

    {
      {
      end
    }
  }

    {
      {
      if eq .Site.Params.customBlockquoteStyle true
    }
  }

  blockquote,
  .blockquote {
    padding: 10px 20px;
    margin: 0 0 20px;
    font-size: 1em;
    border-left: 5px solid #6c757d;
  }

    {
      {
      end
    }
  }
</style>
</head>

<body>
  <nav class="custom-navbar">
  <div class="container">
    
    <a href="/">Personal Wiki</a>
    
    <a href="/post">Posts</a>
    
    <a href="/notes/">Notes</a>
    
    <a href="/tags/">Tags</a>
    
    <a href="/resources/">Resources</a>
    
  </div>
</nav>
  
  <div class="container">
    <article>
      <h1>Postgres full text search</h1>
<p>
  <small class="text-secondary">
    
    
    Jan 2, 2020
  </small>
  

<small><code><a href="https://example.com/tags/postgres">postgres</a></code></small>

</p>
<p>In this guide we will walk through how to implement a full text search
in Postgres to create a custom SQL function and expose it to the GraphQL
API.</p>
<h1 id="what-is-fts">What is FTS?</h1>
<p>Imagine we have a set of text documents stored in a database. These
documents could be an abstract of certain text article or the entire
article itself and we want to find out if certain words are present in
them or not.</p>
<p>The way FTS is implemented in Postgres is by getting a semantic vector
for all the words contained in the document. So, when we search for
words like &quot;jump&quot;, we will match all instances of the word like
&quot;jumping&quot;, &quot;jumped&quot;. So in essence we will be searching just the
vector and not the document which is fast.</p>
<h1 id="functions">Functions</h1>
<p>PostgreSQL has two functions that do exactly what we intend to do:</p>
<ul>
<li><code>to_tsvector</code>: This will create a list of tokens.</li>
<li><code>to_tsquery</code>: To query the vector for occurences of certain words.</li>
</ul>
<p><strong>to_tsvector()</strong></p>
<p>Example: To create a vector for the sentence &quot;The quick brown fox
jumped over the lazy dog&quot;</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#66d9ef">SELECT</span> to_tsvector(<span style="color:#e6db74">&#39;The quick brown fox jumped over the lazy dog&#39;</span>);
</code></pre></div><p>returns:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">to_tsvector
-------------------------------------------------------
<span style="color:#e6db74">&#39;brown&#39;</span>:3 <span style="color:#e6db74">&#39;dog&#39;</span>:9 <span style="color:#e6db74">&#39;fox&#39;</span>:4 <span style="color:#e6db74">&#39;jump&#39;</span>:5 <span style="color:#e6db74">&#39;lazi&#39;</span>:8 <span style="color:#e6db74">&#39;quick&#39;</span>:2
</code></pre></div><p>Every word is normalized into a lexeme.</p>
<blockquote>
<p>Sometimes the word won't be normalized depending on the localization
settings of your postgres installation. Default language is English but
this can be changed by passing the language of you are working with as
an argument.</p>
</blockquote>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#66d9ef">SELECT</span> to_tsvector(<span style="color:#e6db74">&#39;French&#39;</span>, <span style="color:#e6db74">&#39;Le rapide renard brun sauta par dessus le chien paresseux&#39;</span>);
</code></pre></div><p>It would return a vector normalized according to the French language.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">to_tsvector
-------------------------------------------------------------------------
<span style="color:#e6db74">&#39;brun&#39;</span>:4 <span style="color:#e6db74">&#39;chien&#39;</span>:9 <span style="color:#e6db74">&#39;dessus&#39;</span>:7 <span style="color:#e6db74">&#39;paress&#39;</span>:10 <span style="color:#e6db74">&#39;rapid&#39;</span>:2 <span style="color:#e6db74">&#39;renard&#39;</span>:3 <span style="color:#e6db74">&#39;saut&#39;</span>:5
</code></pre></div><p><strong>to_tsquery()</strong></p>
<p>This function will accept a list of words that will be checked against
the normalized vector we created with <code>to_tsvector()</code></p>
<p>Example:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#66d9ef">SELECT</span> to_tsvector(<span style="color:#e6db74">&#39;The quick brown fox jumped over the lazy dog&#39;</span>) <span style="color:#f92672">@@</span> to_tsquery(<span style="color:#e6db74">&#39;fox&#39;</span>);
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">?column?
----------
t
</code></pre></div><p>The <code>@@</code> operator is used to check if the <code>tsquery</code> matches <code>tsvector</code>.</p>
<p><strong>tsquery</strong> also provides a set of operators such as:</p>
<ul>
<li>AND operator (&amp;)</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#66d9ef">SELECT</span> to_tsvector(<span style="color:#e6db74">&#39;The quick brown fox jumped over the lazy dog&#39;</span>) <span style="color:#f92672">@@</span> to_tsquery(<span style="color:#e6db74">&#39;fox &amp; dog&#39;</span>);
</code></pre></div><ul>
<li>OR operator (|)</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#66d9ef">SELECT</span> to_tsvector(<span style="color:#e6db74">&#39;The quick brown fox jumped over the lazy dog&#39;</span>) <span style="color:#f92672">@@</span> to_tsquery(<span style="color:#e6db74">&#39;fox | clown&#39;</span>);
</code></pre></div><ul>
<li>NEGATION operator (!)</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#66d9ef">SELECT</span> to_tsvector(<span style="color:#e6db74">&#39;The quick brown fox jumped over the lazy dog&#39;</span>) <span style="color:#f92672">@@</span> to_tsquery(<span style="color:#e6db74">&#39;!clown&#39;</span>);
</code></pre></div><h1 id="creating-and-storing-the-tsvector-data-type">Creating and Storing the tsvector Data Type</h1>
<p>Let&rsquo;s say we have two simple tables for an article/author schema</p>
<pre><code>author (
  id INT PRIMARY KEY,
  name TEXT
)

article (
  id INT PRIMARY KEY,
  title TEXT,
  content TEXT,
  rating INT,
  author_id INT
)
</code></pre><p>We will store the vectors in the same table instead of vectorizing the
documents on the fly because the execution time is faster.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#66d9ef">ALTER</span> <span style="color:#66d9ef">TABLE</span> article
<span style="color:#66d9ef">ADD</span> <span style="color:#66d9ef">COLUMN</span> document tsvector;
<span style="color:#66d9ef">update</span> article
<span style="color:#66d9ef">set</span> document <span style="color:#f92672">=</span> to_tsvector(title <span style="color:#f92672">||</span> <span style="color:#e6db74">&#39; &#39;</span> <span style="color:#f92672">||</span> content);
</code></pre></div><p>We can take this up another notch up by adding index to the pre computed
tsvector column.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#66d9ef">ALTER</span> <span style="color:#66d9ef">TABLE</span> article
<span style="color:#66d9ef">ADD</span> <span style="color:#66d9ef">COLUMN</span> document_with_idx tsvector;
<span style="color:#66d9ef">update</span> artile
<span style="color:#66d9ef">set</span> document_with_idx <span style="color:#f92672">=</span> to_tsvector(title <span style="color:#f92672">||</span> <span style="color:#e6db74">&#39; &#39;</span> <span style="color:#f92672">||</span> content);
<span style="color:#66d9ef">CREATE</span> <span style="color:#66d9ef">INDEX</span> document_idx
<span style="color:#66d9ef">ON</span> card
<span style="color:#66d9ef">USING</span> GIN (document_with_idx);
</code></pre></div><p>And it can be queried like this</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#66d9ef">SELECT</span> name, artist, text <span style="color:#66d9ef">from</span> card
<span style="color:#66d9ef">WHERE</span> document_with_idx <span style="color:#f92672">@@</span> to_tsquery(<span style="color:#e6db74">&#39;pandoc&#39;</span>);
</code></pre></div>
    </article>
  </div>

  
  
  
  <script>
  window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
  ga('create', 'UA-123456789-1', 'auto');
  ga('send', 'pageview');
  </script>
  <script async src='https://www.google-analytics.com/analytics.js'></script>
  

  

  
<link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.0/cookieconsent.min.css" />
<script src="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.0/cookieconsent.min.js"></script>
<script>
window.addEventListener("load", function(){
window.cookieconsent.initialise({
  "palette": {
    "popup": {
      "background": "#216942",
      "text": "#b2d192"
    },
    "button": {
      "background": "#afed71"
    }
  }
})});
</script>

</body>

</html>
