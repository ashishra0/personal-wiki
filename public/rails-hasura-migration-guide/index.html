<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <meta name="generator" content="Hugo 0.73.0" />

  
  <meta name="description" content="Some description">
  

  
  <link rel="apple-touch-icon" sizes="180x180" href="https://example.com/apple-touch-icon.png">

  
  <link rel="icon" type="image/png" sizes="32x32" href="https://example.com/favicon-32x32.png">

  
  <link rel="icon" type="image/png" sizes="16x16" href="https://example.com/favicon-16x16.png">

  
  <link rel="manifest" href="https://example.com/site.webmanifest">

  
  <link rel="mask-icon" href="https://example.com/safari-pinned-tab.svg" color="#5bbad5">

  <meta name="msapplication-TileColor" content="#da532c">

  <meta name="theme-color" content="#ffffff">

  
  <link rel="stylesheet" href="https://example.com/css/bootstrap.min.css" />

  
  <title>Using Rails migrations with Hasura | Some Title</title>
  

  <style>
  body {
    min-width: 300px;
  }

  .custom-navbar {
    margin-bottom: 1em;
    height: 60px;
  }

  .custom-navbar a {
    display: inline-block;
    padding: 18px 0;
    margin-right: 1em;
    font-weight: bold;
  }

  .custom-navbar a:hover,
  .custom-navbar a:focus {
    text-decoration: none;
  }

  @media print {
    .custom-navbar {
      display: none;
    }
  }

  article {
    padding-bottom: 1em;
  }

  img {
    max-width: 100%;
  }

    {
      {
      with .Site.Params.contentBackgroundColor
    }
  }

  body {
    background-color: {
        {
        . | safeCSS
      }
    }

    ;
  }

    {
      {
      else
    }
  }

  body {
    background-color: #fff;
  }

    {
      {
      end
    }
  }

    {
      {
      with .Site.Params.contentTextColor
    }
  }

  body {
    color: {
        {
        . | safeCSS
      }
    }

    ;
  }

    {
      {
      else
    }
  }

  body {
    color: #212529;
  }

    {
      {
      end
    }
  }

    {
      {
      with .Site.Params.contentLinkColor
    }
  }

  a {
    color: {
        {
        . | safeCSS
      }
    }

    ;
  }

    {
      {
      else
    }
  }

  a {
    color: #007bff;
  }

    {
      {
      end
    }
  }

    {
      {
      with .Site.Params.contentLinkHoverColor
    }
  }

  a:hover,
  a:focus {
    color: {
        {
        . | safeCSS
      }
    }

    ;
  }

    {
      {
      else
    }
  }

  a:hover,
  a:focus {
    color: #0056b3;
  }

    {
      {
      end
    }
  }

    {
      {
      with .Site.Params.navbarBackgroundColor
    }
  }

  .custom-navbar {
    background-color: {
        {
        . | safeCSS
      }
    }

    ;
  }

    {
      {
      else
    }
  }

  .custom-navbar {
    background-color: #212529;
  }

    {
      {
      end
    }
  }

    {
      {
      with .Site.Params.navbarLinkColor
    }
  }

  .custom-navbar a {
    color: {
        {
        . | safeCSS
      }
    }

    ;
  }

    {
      {
      else
    }
  }

  .custom-navbar a {
    color: rgba(255, 255, 255, .75);
  }

    {
      {
      end
    }
  }

    {
      {
      with .Site.Params.navbarLinkHoverColor
    }
  }

  .custom-navbar a:hover,
  .custom-navbar a:focus {
    color: {
        {
        . | safeCSS
      }
    }

    ;
  }

    {
      {
      else
    }
  }

  .custom-navbar a:hover,
  .custom-navbar a:focus {
    color: rgba(255, 255, 255, 1);
  }

    {
      {
      end
    }
  }

    {
      {
      with .Site.Params.wrapperMaxWidth
    }
  }

  .container {
    max-width: {
        {
        . | safeCSS
      }
    }

    ;
  }

    {
      {
      else
    }
  }

  .container {
    max-width: 800px;
  }

    {
      {
      end
    }
  }

    {
      {
      if eq .Site.Params.customCodeStyle true
    }
  }

  pre {
    display: block;
    padding: 9.5px;
    word-break: break-all;
    word-wrap: break-word;
    background-color: #f5f5f5;
    border: 1px solid #ccc;
    border-radius: 4px;
  }

  pre code {
    padding: 0;
    font-size: inherit;
    color: inherit;
    white-space: pre-wrap;
    background-color: transparent;
    border: none;
    border-radius: 0;
  }

  code {
    padding: 2px 4px;
    color: inherit;
    background-color: #f5f5f5;
    border: 1px solid #ccc;
    border-radius: 4px;
    font-size: .9em;
  }

    {
      {
      end
    }
  }

    {
      {
      if eq .Site.Params.customBlockquoteStyle true
    }
  }

  blockquote,
  .blockquote {
    padding: 10px 20px;
    margin: 0 0 20px;
    font-size: 1em;
    border-left: 5px solid #6c757d;
  }

    {
      {
      end
    }
  }
</style>
</head>

<body>
  <nav class="custom-navbar">
  <div class="container">
    
    <a href="/">Personal Wiki</a>
    
    <a href="/post">Posts</a>
    
    <a href="/notes/">Notes</a>
    
    <a href="/tags/">Tags</a>
    
    <a href="/resources/">Resources</a>
    
  </div>
</nav>
  
  <div class="container">
    <article>
      <h1>Using Rails migrations with Hasura</h1>
<p>
  <small class="text-secondary">
    
    
    Feb 12, 2020
  </small>
  

<small><code><a href="https://example.com/tags/rails">Rails</a></code></small>

</p>
<p>This guide assumes you have a Rails application setup with postgres database and a Hasura
instance running.</p>
<h1 id="introduction">Introduction</h1>
<p>Hasura comes with a migration tool out of the box to help you manage your Postgres schema, So if
we create a table on the console then hasura automatically tracks the table and then that
information is added to the metadata which indicates the newly created table should be exposed
via GraphQL engine.
In our case we have a Postgres database which is managed by the Active Record Migration system,
hence we don’t need to depend on Hasura migrations. Whenever we make any changes to our
schema like creating a new table Hasura won’t automatically track the table and expose it to
GraphQL engine, this has to be done manually.
In this guide we will explore how to manually track tables.</p>
<h1 id="prerequisites">Prerequisites</h1>
<p>If you don’t have the CLI installed then follow the installation docs ​<a href="https://hasura.io/docs/1.0/graphql/manual/migrations/existing-database.html">here</a>.</p>
<h1 id="set-up-a-project-directory">Set up a project directory</h1>
<p>Inside your rails application directory</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ hasura init --directory hasura --endpoint http://mygraphql-endpoint.com
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ cd hasura
</code></pre></div><p>The project directory should look more or less the same depending on your application use-case.</p>
<p><img src="/static/image_preview.png" alt="file-structure"></p>
<h1 id="adding-tables">Adding tables</h1>
<p>Let’s create few tables</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ rails generate model User name:string
$ rails generate model Post user_id:integer:index body:text
</code></pre></div><p>Run the migration</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ rails db:migrate
</code></pre></div><p>Now head over to hasura console and you should see the newly created tables ready to track, we
won’t be using the console to track each table.</p>
<p><img src="/static/image_preview_1.png" alt="console-img ><"></p>
<p>Instead, we will export the metadata from the console and update the metadata each time we create
a new table in rails. The hasura CLI has few commands which will let us simplify this task.</p>
<h1 id="the-cli">The CLI</h1>
<p>Inside the hasura directory type in the following commands</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ hasura metadata export
</code></pre></div><p>This command will export Hasura metadata and save it in the migrations/metadata.yaml file. This
file includes all the information about tables that are tracked, permission rules, relationships and
event triggers that are defined on those tables. We will be editing this file manually to indicate the
server to track the tables.
Open up the metadata.yaml file and edit the file by adding the table names you want to track, in our
case posts and users</p>
<p><img src="/static/image_preview_2.png" alt="metadata.yml ><"></p>
<p>We will have to apply the changes back to the server, type in the following</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ hasura metadata apply
</code></pre></div><p>Navigate back to the console and you should see both the users and posts table now being tracked
by the server.</p>
<p><img src="/static/image_preview_4.png" alt="console-image ><"></p>
<p>Perfect, we have successfully tracked tables created by rails. Hence, every time you do a migration in
your rails app update the metadata.yaml file and apply it back to the server.</p>

    </article>
  </div>

  
  
  
  <script>
  window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
  ga('create', 'UA-123456789-1', 'auto');
  ga('send', 'pageview');
  </script>
  <script async src='https://www.google-analytics.com/analytics.js'></script>
  

  

  
<link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.0/cookieconsent.min.css" />
<script src="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.0/cookieconsent.min.js"></script>
<script>
window.addEventListener("load", function(){
window.cookieconsent.initialise({
  "palette": {
    "popup": {
      "background": "#216942",
      "text": "#b2d192"
    },
    "button": {
      "background": "#afed71"
    }
  }
})});
</script>

</body>

</html>
